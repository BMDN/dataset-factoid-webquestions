#!/usr/bin/python -u
#
# Creates dataset of freebase mids generated from question concepts
#
# Usage: freebase_mids.py dump.json
#
# File dump.json needs to contain array of objetcs for each question. Each object needs to have following fields:
# qId and Concepts. This file can be generated by YodaQA command ./gradlew questionDump.

from __future__ import print_function

from SPARQLWrapper import SPARQLWrapper, JSON
import json, sys

def queryFreebasekey(page_id):
    url = 'http://freebase.ailao.eu:3030/freebase/query'
    sparql = SPARQLWrapper(url)
    sparql.setReturnFormat(JSON)
    sparql_query = '''
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX ns: <http://rdf.freebase.com/ns/>
SELECT * WHERE { 
?topic <http://rdf.freebase.com/key/wikipedia.en_id> "''' + page_id + '''" .
} '''
    sparql.setQuery(sparql_query)
    res = sparql.query().convert()
    s = set()
    retVal = []
    for r in res['results']['bindings']:
        if (r['topic']['value'] not in s):
            retVal.append(r['topic']['value'][27:])
        s.add(r['topic']['value'])
    if (len(retVal) < 1):
        return ""
    else:
        return retVal[0]

print("[")
with open(sys.argv[1]) as f:
    dump = json.load(f)
    for i, line in enumerate(dump):
        res_line = {}
        res_line['qId'] = line['qId']
        res_line['freebaseMids'] = []
        for c in line['Concept']:
            print('%s (%s) ? %s / %s' % (line['qId'], line['qText'], c['fullLabel'], c['pageID']), file=sys.stderr)
            pair = {}
            pair['concept'] = c['fullLabel']
            pair['mid'] = queryFreebasekey(c['pageID'])
            res_line['freebaseMids'].append(pair)
        # print (json.dumps(res_line))
        if (i+1 != len(dump)):
            print(json.dumps(res_line, sort_keys=True) + ",")
        else:
            print(json.dumps(res_line, sort_keys=True))
print("]")
